package me.nuf.glade.module.impl.exploits;

import me.nuf.glade.module.Category;
import me.nuf.glade.module.ToggleableModule;
import me.nuf.glade.properties.NumberProperty;
import me.nuf.glade.properties.Property;
import me.nuf.glade.subjects.MotionUpdateSubject;
import me.nuf.subjectapi.Listener;
import net.minecraft.item.Item;
import net.minecraft.item.ItemBucketMilk;
import net.minecraft.item.ItemFood;
import net.minecraft.item.ItemPotion;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C07PacketPlayerDigging;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;

/**
 * Created by nuf on 3/21/2016.
 */
public final class FastConsume extends ToggleableModule {
    private final NumberProperty<Integer> delay = new NumberProperty<>(15, 0, 25, "Delay", "d");
    private final Property<Boolean> instant = new Property<>(false, "Instant", "i", "insta");

    public FastConsume() {
        super(new String[]{"FastConsume", "fastuse", "fc", "instantuse", "iu"}, true, 0xFFB8D1FC, Category.EXPLOITS);
        this.offerProperties(delay, instant);
        this.addListeners(new Listener<MotionUpdateSubject>("fast_consume_motion_update_listener") {
            @Override
            public void call(MotionUpdateSubject subject) {
                if (shouldUse()) {
                    for (int index = 0; index < 15; index++) {
                        minecraft.getNetHandler().addToSendQueue(new C03PacketPlayer(minecraft.thePlayer.onGround));
                        minecraft.getNetHandler().addToSendQueue(new C03PacketPlayer(minecraft.thePlayer.onGround));
                        minecraft.getNetHandler().addToSendQueue(new C03PacketPlayer(minecraft.thePlayer.onGround));
                        minecraft.getNetHandler().addToSendQueue(new C03PacketPlayer(minecraft.thePlayer.onGround));
                        minecraft.getNetHandler().addToSendQueue(new C03PacketPlayer(minecraft.thePlayer.onGround));
                    }
                    minecraft.getNetHandler().addToSendQueue(new C07PacketPlayerDigging(
                            C07PacketPlayerDigging.Action.RELEASE_USE_ITEM, new BlockPos(-1, -1, -1), EnumFacing.DOWN));
                    minecraft.thePlayer.stopUsingItem();
                }
            }
        });
    }

    private boolean shouldUse() {
        if (minecraft.thePlayer.inventory.getCurrentItem() == null)
            return false;
        Item item = minecraft.thePlayer.inventory.getCurrentItem().getItem();
        if (minecraft.thePlayer.getItemInUseCount() == delay.getValue() || instant.getValue())
            if (minecraft.thePlayer.onGround && !minecraft.thePlayer.isInWater() && !minecraft.thePlayer.isInLava() && minecraft.thePlayer.isCollidedVertically)
                if (item instanceof ItemFood || item instanceof ItemPotion || item instanceof ItemBucketMilk)
                    return true;
        return false;
    }
}
